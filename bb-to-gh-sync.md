# Bitbucket to GitHub sync

This syncs the contents of a Bitbucket repository to a corresponding GitHub repository.

1. Generate a public/private key pair as described [here](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent). Make sure to generate a key _without_ a passphrase.
2. In your Bitbucket repository, make sure pipelines are enabled under `Repository Settings->Pipelines->Settings`.
3. Go to `Repository Settings->Pipelines->SSH Keys`.
4. Click `Use my own keys`. Copy the private and public keys into the appropriate textboxes and click `Save key pair`.
5. Go to `Security->Access keys` and click `Add key`. Specify a label (e.g. `Bitbucket-to-GitHub sync`) and paste the public key into the `Key` textbox, then click `Add SSH key`.
6. Go to the `Settings` page for the target repository on GitHub, then select `Deploy keys`.
7. Click `Add deploy key`, enter a title (e.g., `Bitbucket-to-GitHub sync`), and paste the public key generated by Bitbucket into the `Key` textbox. Make sure the `Allow write access` checkbox is checked before clicking `Add key`.
8. Add a file named `bitbucket-pipelines.yml` to the top-level of your repository. The contents are shown below.

Once you push the commit including `bitbucket-pipelines.yml`, that and any subsequent commits should be reflected within a matter of seconds on the mirroring GitHub repository.

## bitbucket-pipelines.yml

```
clone:
  depth: full
pipelines:
  default:
    - step:
        script:
          - git checkout main
          - git push --mirror git@github.com:rherrick/sandbox-cli.git
```

**Note:** The `git checkout main` statement is necessary to prevent the pipeline from failing. Running the `git push` on its own actually seems to sync the repositories properly, but something goes wrong:

```
+ git push --mirror git@github.com:YourRepo/xxx.git
Warning: Permanently added the ECDSA host key for IP address 'a.b.c.d' to the list of known hosts.
remote: To git@github.com:YourRepo/xxx.git
 * [new branch]      dev -> dev
 * [new branch]      origin/dev -> origin/dev
 ! [remote rejected] main (refusing to delete the current branch: refs/heads/main)
error: failed to push some refs to 'git@github.com:YourRepo/xxx.git'
```

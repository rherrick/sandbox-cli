# Bitbucket to GitHub sync

This syncs the contents of a Bitbucket repository to a corresponding GitHub repository.

1. Generate a public/private key pair as described [here](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent). Make sure to generate a key _without_ a passphrase.
2. In your Bitbucket repository, make sure pipelines are enabled under `Repository Settings->Pipelines->Settings`.
3. Go to `Repository Settings->Pipelines->SSH Keys`.
4. Click `Use my own keys`. Copy the private and public keys into the appropriate textboxes and click `Save key pair`.
5. Go to `Security->Access keys` and click `Add key`. Specify a label (e.g. `Bitbucket-to-GitHub sync`) and paste the public key into the `Key` textbox, then click `Add SSH key`.
6. Go to the `Settings` page for the target repository on GitHub, then select `Deploy keys`.
7. Click `Add deploy key`, enter a title (e.g., `Bitbucket-to-GitHub sync`), and paste the public key generated by Bitbucket into the `Key` textbox. Make sure the `Allow write access` checkbox is checked before clicking `Add key`.
8. Add a file named `bitbucket-pipelines.yml` to the top-level of your repository. The contents are shown below.

Once you push the commit including `bitbucket-pipelines.yml`, that and any subsequent commits should be reflected within a matter of seconds on the mirroring GitHub repository.

## bitbucket-pipelines.yml

```
pipelines:
  default:
    - step:
        name: Sync GitHub Mirror
        image: alpine/git:latest
        clone:
          enabled: false
        script:
          - git clone --bare git@bitbucket.org:rickatfw/sandbox-cli.git
          - cd sandbox-cli.git
          - git push --mirror git@github.com:rherrick/sandbox-cli.git

```

**Note:** Bitbucket's pipeline DSL has a `clone` feature that could be used for syncing. However, I ran into errors using the clone with `git push --mirror`. With just that, the sync would work properly, but the pipeline would fail because it tries to overwrite a branch on the downstream destination. Adding `git checkout main` eliminated the error, but would also delete any branch _other_ than `main` on the downstream. This approach is slightly clunkier but results in both a successful pipeline execution and all branches being properly mirrored on the downstream.

